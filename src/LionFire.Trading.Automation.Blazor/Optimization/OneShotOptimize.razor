@page "/optimize/one-shot"
@* @inherits ReactiveInjectableComponentBase<OneShotOptimizeVM> *@
@inherits ReactiveComponentBase<OneShotOptimizeVM>

@* @rendermode InteractiveServer *@
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@using LionFire.Blazor.Components.Terminal
@using MudBlazor.Components
@using Humanizer
@using LionFire.Trading.Optimization.Queue
@using LionFire.Trading.Automation.Blazor.Optimization.Dashboard
@using LionFire.Trading.Automation.Blazor.Optimization.Components

@* This page is a quick UI for optimizing right from a Worker process' UI.  The long-term approach favors a FireLynx workbench that supports Optimize documents which can be saved/loaded.  *@

@* <LionFire.Trading.Automation.Blazor.Infra.CpuChart/> *@


<div class="d-flex flex-column flex-grow-1 gap-2">

    @* Queue Status Panel *@
    @if (ViewModel!.QueueStatus != null && (ViewModel.QueueStatus.QueuedCount > 0 || ViewModel.QueueStatus.RunningCount > 0 || ViewModel.HasQueuedJob))
    {
        <MudPaper Class="pa-4">
            <div class="d-flex flex-row align-center gap-4">
                <MudIcon Icon="@Icons.Material.Filled.Queue" />
                <div class="d-flex flex-row gap-6">
                    <div class="lf-field">
                        <div class="label">Queued</div>
                        <div class="value">@ViewModel.QueueStatus.QueuedCount</div>
                    </div>
                    <div class="lf-field">
                        <div class="label">Running</div>
                        <div class="value">@ViewModel.QueueStatus.RunningCount</div>
                    </div>
                    <div class="lf-field">
                        <div class="label">Completed</div>
                        <div class="value">@ViewModel.QueueStatus.CompletedCount</div>
                    </div>
                    @if (ViewModel.HasQueuedJob && ViewModel.QueuedJob!.Status == OptimizationJobStatus.Queued)
                    {
                        <div class="lf-field">
                            <div class="label">Your Position</div>
                            <div class="value">#@(ViewModel.QueuePosition ?? 0)</div>
                        </div>
                        @if (ViewModel.EstimatedStartTime.HasValue)
                        {
                            <div class="lf-field">
                                <div class="label">Est. Start</div>
                                <div class="value">@ViewModel.EstimatedStartTime.Value.Humanize()</div>
                            </div>
                        }
                    }
                    @if (ViewModel.HasQueuedJob && ViewModel.QueuedJob!.Status == OptimizationJobStatus.Running)
                    {
                        <div class="lf-field">
                            <div class="label">Status</div>
                            <div class="value">Running</div>
                        </div>
                        @if (ViewModel.QueuedJob.Progress != null)
                        {
                            <div class="lf-field">
                                <div class="label">Progress</div>
                                <div class="value">@ViewModel.QueuedJob.Progress.PerUn.ToString("P1")</div>
                            </div>
                        }
                    }
                </div>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="@ViewModel.RefreshQueueStatus" Size="Size.Small" />
            </div>
        </MudPaper>
    }

    @* ▉▉▉▉___  Toolbar: [Abort] [Optimize] *@
    <MudPaper id="TopActionAndProgressBar" Class="gap-6 d-flex flex-row justify-end pa-6">
        <OptimizationProgressPanel ViewModel="ViewModel"
                                   PlannedScanTotal="@(ViewModel!.POptimization?.LevelsOfDetail?.PlannedScanTotal ?? 0)" />

        <RuntimeStatsForOptimization />

        <div>
            <div class="lf-field row">
                <div class="value">@((ViewModel.POptimization.LevelsOfDetail.ComprehensiveScanPerUn).ToString("P0"))</div>
                <div class="label">Comprehensiveness</div>
            </div>
            <MudProgressLinear Value="ViewModel.POptimization.LevelsOfDetail.ComprehensiveScanPerUn" Min="0" Max="1"
                               Color="ComprehensivenessColor" />
            @* <MudProgressCircular Min="0" Max="1" Value="ViewModel.POptimization.LevelsOfDetail.ComprehensiveScanPerUn" /> *@
        </div>

        @if (ViewModel!.IsRunning)
        {
            <MudIconButton OnClick="@ViewModel!.Cancel" Color="@(ViewModel.IsRunning ? Color.Error : Color.Dark)" Variant="@(ViewModel!.IsAborting ? Variant.Filled : Variant.Outlined)" Size="Size.Large" Disabled=!ViewModel!.IsRunning Icon="@Icons.Material.Filled.Stop" >
                @if (ViewModel!.IsAborting)
                {
                    <text>Aborting...</text>
                    <MudProgressCircular Color="Color.Default" />
                }
                else
                {
                    <text>Abort</text>
                }
            </MudIconButton>
        }

        <MudButton OnClick="@ViewModel!.DoGC" Color="Color.Dark" Variant="Variant.Outlined" Size="Size.Small">
            <text>GC</text>
        </MudButton>
        <MudButton OnClick="@ViewModel!.Reset" Color="Color.Tertiary" Variant="Variant.Outlined" Size="Size.Large">
            <text>Clear</text>
        </MudButton>

        <MudButton OnClick="ViewModel.OnOptimize" Color="Color.Primary" Variant="@(ViewModel!.IsRunning && !ViewModel!.IsAborting ? Variant.Filled : Variant.Outlined)" Size="Size.Large">
            @if (ViewModel!.IsRunning)
            {
                <text>Optimizing...</text>
            }
            else
            {
                <text>Optimize</text>
            }
        </MudButton>

        @if (ViewModel!.HasQueuedJob)
        {
            <MudButton OnClick="@ViewModel!.OnCancelQueued" Color="Color.Warning" Variant="Variant.Outlined" Size="Size.Large" StartIcon="@Icons.Material.Filled.Cancel">
                @if (ViewModel.QueuedJob!.Status == OptimizationJobStatus.Queued)
                {
                    <text>Cancel Queued (#@(ViewModel.QueuePosition ?? 0))</text>
                }
                else if (ViewModel.QueuedJob.Status == OptimizationJobStatus.Running)
                {
                    <text>Cancel Running</text>
                }
                else
                {
                    <text>@ViewModel.QueuedJob.Status.ToString()</text>
                }
            </MudButton>
        }
        else
        {
            <MudButton OnClick="@(() => ViewModel!.OnQueue())" Color="Color.Secondary" Variant="Variant.Outlined" Size="Size.Large" StartIcon="@Icons.Material.Filled.Queue" Disabled="@ViewModel!.IsRunning">
                <text>Queue</text>
            </MudButton>
        }
    </MudPaper>

    <MudPaper Class="pa-6">
        <GeneralParameters ViewModel="ViewModel" />
    </MudPaper>

    @* ======================= NESTED TABS LAYOUT ======================= *@
    <div style="overflow-y: auto; flex-grow: 1;">
        @* Top-level horizontal category tabs (Parameters / Results) *@
        <MudTabs @bind-ActivePanelIndex="_categoryTabIndex" Border="true" Outlined="true" Elevation="2" Rounded="true"
                 ApplyEffectsToContainer="true" Style="height: 100%;">
            <ChildContent>
                @* ======================= PARAMETERS CATEGORY ======================= *@
                <MudTabPanel Text="Parameters" Icon="@Icons.Material.Filled.Tune">
                    @* Vertical sub-tabs for parameter-related content *@
                    <MudTabs Position="Position.Left" @bind-ActivePanelIndex="_parameterSubTabIndex"
                             MinimumTabWidth="160px" Class="vertical-subtabs" PanelClass="pa-4"
                             Border="true" Style="height: 100%;">
                        <MudTabPanel Text="Parameters" Icon="@Icons.Material.Filled.Settings">
                            <OptimizeParameters ViewModel="ViewModel" />
                        </MudTabPanel>
                        <MudTabPanel Text="Level of Detail" Icon="@Icons.Material.Filled.Layers">
                            <OptimizationStatus ViewModel="ViewModel" />
                        </MudTabPanel>
                        <MudTabPanel Text="Performance" Icon="@Icons.Material.Filled.Speed">
                            <PerformanceTuning ViewModel="ViewModel" />
                        </MudTabPanel>
                        <MudTabPanel Text="Properties" Icon="@Icons.Material.Filled.ListAlt">
                            <ObjectExplorer CurrentObject="ViewModel" />
                        </MudTabPanel>
                        <MudTabPanel Text="Output" Icon="@Icons.Material.Filled.Output">
                            <OutputParameters ViewModel="ViewModel" />
                        </MudTabPanel>
                    </MudTabs>
                </MudTabPanel>

                @* ======================= RESULTS CATEGORY ======================= *@
                <MudTabPanel Text="Results" Icon="@Icons.Material.Filled.Assessment">
                    @* Vertical sub-tabs for results-related content *@
                    <MudTabs Position="Position.Left" @bind-ActivePanelIndex="_resultsSubTabIndex"
                             MinimumTabWidth="160px" Class="vertical-subtabs" PanelClass="pa-4"
                             Border="true" Style="height: 100%;">
                        <MudTabPanel Text="Summary" Icon="@Icons.Material.Filled.Summarize">
                            <ResultsSummary ViewModel="ViewModel" />
                        </MudTabPanel>
                        <MudTabPanel Text="Backtests" Icon="@Icons.Material.Filled.TableChart">
                            <BacktestResultsPanel ViewModel="ViewModel" />
                        </MudTabPanel>
                        <MudTabPanel Text="Statistics" Icon="@Icons.Material.Filled.BarChart">
                            <LionFire.Trading.Automation.Blazor.Optimization.Charts.StatisticsHistogram ViewModel="ViewModel" />
                        </MudTabPanel>
                        <MudTabPanel Text="Dashboard 1" Icon="@Icons.Material.Filled.Dashboard" Style="width: 100%; height: 100%;">
                            <div style="width: 100%; height: 100%; min-height: 500px;">
                                <OptimizationDashboard ViewModel="ViewModel" DashboardName="dashboard1" />
                            </div>
                        </MudTabPanel>
                        <MudTabPanel Text="Dashboard 2" Icon="@Icons.Material.Filled.Dashboard" Style="width: 100%; height: 100%;">
                            <div style="width: 100%; height: 100%; min-height: 500px;">
                                <OptimizationDashboard ViewModel="ViewModel" DashboardName="dashboard2" />
                            </div>
                        </MudTabPanel>
                    </MudTabs>
                </MudTabPanel>
            </ChildContent>
        </MudTabs>
    </div>

    <MudSpacer />
    <div style="min-height: 50px;">
        <MudExpansionPanels>
            <MudExpansionPanel Text="Log" @bind-Expanded=@ShowLog>
                <div style="height: 200px; overflow: auto;">
                    <TerminalView ViewModel="ViewModel!.LinesVM" />
                </div>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </div>
</div>


