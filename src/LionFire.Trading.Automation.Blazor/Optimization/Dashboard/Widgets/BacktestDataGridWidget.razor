@inherits OptimizationWidgetBase
@using System.Reactive.Linq
@using ReactiveUI
@using LionFire.Trading.Automation
@using LionFire.Reactive.Persistence
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.Extensions.Logging
@inject IServiceProvider ServiceProvider
@inject ILogger<BacktestDataGridWidget> Logger
@implements IDisposable

<div style="height: 100%; width: 100%;">
@if (ViewModel?.Backtests?.Items != null)
{
    <MudDataGrid T="BacktestBatchJournalEntry"
                 Items="ViewModel.GetFilteredBacktests()"
                 Virtualize="true"
                 FixedHeader="true"
                 Height="100%"
                 Dense="true"
                 Hover="true"
                 SelectedItem="_selectedItem"
                 SelectedItemChanged="OnSelectedItemChanged"
                 RowClassFunc="@GetRowClass"
                 RowStyleFunc="@GetRowStyle">
        <Columns>
            <TemplateColumn Title="Show" Sortable="false" Filterable="false">
                <CellTemplate>
                    <MudCheckBox T="bool"
                                 Value="@(!ViewModel.HiddenFromChart.Contains(context.Item.StringId))"
                                 ValueChanged="@((bool v) => ViewModel.SetChartVisibility(context.Item, v))"
                                 Size="Size.Small"
                                 Dense="true"
                                 Color="Color.Primary" />
                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.AD" Format="N2" Title="AD" CellClass="text-align-right" />
            <PropertyColumn Property="x => x.Fitness" Format="N1" Title="Fitness" Hideable="true" />
            <PropertyColumn Property="x => x.TotalTrades" Title="Trades" Hideable="true" />
            <PropertyColumn Property="x => x.WinRate" Format="P1" Title="Win%" Hideable="true" />
            <PropertyColumn Property="x => x.AMWT" Format="N0" Title="AMWT" Hideable="true" />
            <PropertyColumn Property="x => x.MaxBalanceDrawdownPerunum" Format="P1" Title="MaxDD" Hideable="true" />

            <TemplateColumn Title="Flags" Sortable="false">
                <CellTemplate>
                    @if (context.Item.IsAborted)
                    {
                        <MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.CancelPresentation"
                                 Color="@Color.Error" Style="opacity: 0.7;" />
                    }
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="Actions" Sortable="false">
                <CellTemplate>
                    @{
                        var botId = GetBotId(context.Item);
                        var botExists = IsBotOnDisk(botId);
                        var inPortfolio = IsBotInPortfolio(botId);
                    }
                    <MudIconButton Icon="@(botExists ? Icons.Material.Filled.AddCircle : Icons.Material.Outlined.AddCircle)"
                                   Size="Size.Small"
                                   Color="@(botExists ? Color.Success : Color.Primary)"
                                   Title="@(botExists ? "Bot already exists on disk" : "Create bot on disk")"
                                   OnClick="@(() => OnExportToBot(context.Item))" />
                    <MudTooltip Text="@(Portfolio == null ? "Select a portfolio first" : (inPortfolio ? "Bot is in portfolio" : "Add bot to portfolio"))">
                        <MudIconButton Icon="@(inPortfolio ? Icons.Material.Filled.Folder : Icons.Material.Outlined.FolderOpen)"
                                       Size="Size.Small"
                                       Color="@(inPortfolio ? Color.Success : Color.Primary)"
                                       Disabled="@(Portfolio == null)"
                                       OnClick="@(() => OnAddToPortfolio(context.Item))" />
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.StringId" Title="ID" Hideable="true" Hidden="true" />
        </Columns>
    </MudDataGrid>
}
else
{
    <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true">
        No backtest results yet. Run an optimization to see results here.
    </MudAlert>
}
</div>

@code {
    private BacktestBatchJournalEntry? _selectedItem;
    private IDisposable? _subscription;
    private IObservableReaderWriter<string, BotEntity>? _workspaceBots;

    [CascadingParameter(Name = "UserServices")]
    public IServiceProvider? UserServices { get; set; }

    [CascadingParameter(Name = "Portfolio")]
    public Portfolio2? Portfolio { get; set; }

    [CascadingParameter(Name = "WorkspaceServices")]
    public IServiceProvider? WorkspaceServices { get; set; }

    private IObservableReaderWriter<string, Portfolio2>? _portfolioWriter;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Get bots writer from UserServices (user-level) or fall back to root ServiceProvider
        var effectiveServices = UserServices ?? ServiceProvider;
        _workspaceBots = effectiveServices.GetService<IObservableReaderWriter<string, BotEntity>>();
        if (_workspaceBots == null)
        {
            Logger.LogWarning("IObservableReaderWriter<string, BotEntity> service not available from {ServiceSource} - Export to Bot will not work",
                UserServices != null ? "UserServices" : "ServiceProvider (fallback)");
        }

        // Get portfolio writer from WorkspaceServices
        _portfolioWriter = WorkspaceServices?.GetService<IObservableReaderWriter<string, Portfolio2>>();
        if (_portfolioWriter == null)
        {
            Logger.LogWarning("IObservableReaderWriter<string, Portfolio2> service not available - Add to Portfolio will not persist");
        }

        if (ViewModel != null)
        {
            _subscription = ViewModel.WhenAnyValue(x => x.SelectedBacktest)
                .Subscribe(selected =>
                {
                    _selectedItem = selected;
                    InvokeAsync(StateHasChanged);
                });
        }
    }

    public void Dispose()
    {
        _subscription?.Dispose();
    }

    private void OnSelectedItemChanged(BacktestBatchJournalEntry? item)
    {
        _selectedItem = item;
        if (ViewModel != null)
        {
            ViewModel.SelectedBacktest = item;
        }
    }

    private string GetBotId(BacktestBatchJournalEntry item)
    {
        return $"{ViewModel?.OptimizationRunInfo.Guid};{item.BatchId}-{item.Id}";
    }

    private bool IsBotOnDisk(string botId)
    {
        if (_workspaceBots == null) return false;
        return _workspaceBots.ObservableCache.Lookup(botId).HasValue;
    }

    private bool IsBotInPortfolio(string botId)
    {
        if (Portfolio?.BotIds == null) return false;
        return Portfolio.BotIds.Contains(botId);
    }

    private void OnExportToBot(BacktestBatchJournalEntry item)
    {
        if (_workspaceBots == null)
        {
            Logger.LogError("Cannot export to bot: IObservableReaderWriter<string, BotEntity> service not available");
            return;
        }
        Logger.LogInformation("Exporting backtest {BatchId}-{Id} to bot", item.BatchId, item.Id);
        ViewModel?.OnExportToBot(item, _workspaceBots);
        StateHasChanged(); // Refresh to update button state
    }

    private async Task OnAddToPortfolio(BacktestBatchJournalEntry item)
    {
        if (Portfolio == null)
        {
            Logger.LogWarning("Cannot add to portfolio: No portfolio selected");
            return;
        }

        var botId = GetBotId(item);

        // First ensure the bot exists on disk
        if (!IsBotOnDisk(botId))
        {
            if (_workspaceBots == null)
            {
                Logger.LogError("Cannot create bot: IObservableReaderWriter<string, BotEntity> service not available");
                return;
            }
            Logger.LogInformation("Creating bot {BotId} before adding to portfolio", botId);
            ViewModel?.OnExportToBot(item, _workspaceBots);
        }

        // Add to portfolio if not already there
        if (!IsBotInPortfolio(botId))
        {
            Portfolio.BotIds ??= new List<string>();
            Portfolio.BotIds.Add(botId);
            Logger.LogInformation("Added bot {BotId} to portfolio {PortfolioName}", botId, Portfolio.Name);

            // Save the portfolio
            if (_portfolioWriter != null && Portfolio.Name != null)
            {
                try
                {
                    await _portfolioWriter.Write(Portfolio.Name, Portfolio);
                    Logger.LogInformation("Saved portfolio {PortfolioName}", Portfolio.Name);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failed to save portfolio {PortfolioName}", Portfolio.Name);
                }
            }
            else
            {
                Logger.LogWarning("Cannot save portfolio: writer not available or portfolio name is null");
            }
        }
        else
        {
            Logger.LogInformation("Bot {BotId} already in portfolio {PortfolioName}", botId, Portfolio.Name);
        }

        StateHasChanged(); // Refresh to update button state
    }

    private string GetRowClass(BacktestBatchJournalEntry item, int index)
    {
        if (item == _selectedItem)
            return "selected-row";
        return string.Empty;
    }

    private string GetRowStyle(BacktestBatchJournalEntry item, int index)
    {
        if (item == _selectedItem)
            return "background-color: rgba(var(--mud-palette-primary-rgb), 0.2);";
        if (item.IsAborted)
            return "opacity: 0.6;";
        return string.Empty;
    }
}
