@page "/bots"

@using LionFire.Reactive.Persistence
@using LionFire.Trading.Automation
@using Microsoft.Extensions.DependencyInjection
@using LionFire.Data.Mvvm
@using DynamicData
@using DynamicData.Binding
@using System.Reactive.Linq
@using Microsoft.Extensions.Logging
@using ReactiveUI
@using System.Diagnostics
@using System.Timers
@using LionFire.Trading.Grains.Bots
@using LionFire.Trading.Grains.User
@using Orleans
@using MudBlazor

@inject IDialogService DialogService
@inject BotTypeRegistry BotTypeRegistry
@implements IDisposable

<div class="pa-6">
	@if (string.IsNullOrEmpty(EffectivePortfolioId))
	{
		<MudAlert Severity="Severity.Info">
			<MudText>No portfolio selected. Please select a portfolio to view its bots.</MudText>
		</MudAlert>
	}
	else if (CurrentPortfolio == null)
	{
		<MudAlert Severity="Severity.Warning">
			<MudText>Portfolio '@EffectivePortfolioId' not found.</MudText>
		</MudAlert>
	}
	else if (FilteredBotCache != null)
	{
		<MudStack Row AlignItems="AlignItems.Center" Class="mb-4">
			<MudText Typo="Typo.h5">
				Bots in Portfolio: @CurrentPortfolio.Name
			</MudText>
			<MudSpacer />
			<MudMenu Icon="@Icons.Material.Filled.ViewColumn"
			         AnchorOrigin="Origin.BottomLeft"
			         TransformOrigin="Origin.TopLeft"
			         Dense="true"
			         AriaLabel="Column Visibility">
				@foreach (var col in ColumnDefinitions)
				{
					<MudMenuItem OnClick="@(() => ToggleColumnVisibility(col.Id))">
						<MudStack Row AlignItems="AlignItems.Center" Spacing="2">
							<MudCheckBox T="bool" Value="@IsColumnVisible(col.Id)" ValueChanged="@((bool _) => ToggleColumnVisibility(col.Id))" Size="Size.Small" />
							<MudText>@col.Name</MudText>
						</MudStack>
					</MudMenuItem>
				}
				<MudDivider />
				<MudMenuItem OnClick="@ResetColumnVisibility">
					<MudStack Row AlignItems="AlignItems.Center" Spacing="2">
						<MudIcon Icon="@Icons.Material.Filled.RestartAlt" Size="Size.Small" />
						<MudText>Reset to Defaults</MudText>
					</MudStack>
				</MudMenuItem>
			</MudMenu>
			<MudButton StartIcon="@Icons.Material.Filled.Add"
			           Variant="Variant.Outlined"
			           Color="Color.Success"
			           OnClick="AddBotAsync">
				Add Bot
			</MudButton>
		</MudStack>

		<ObservableDataView @ref=ItemsEditor
							DataReader="@FilteredBotCache"
							DataServiceProvider="UserServices"
							TKey="string"
							TValue="BotEntity"
							TValueVM="BotVM"
							AllowedEditModes=EditMode.All
							ReadOnly=false>
			<Columns>
				<HierarchyColumn T="BotVM" />

				@if (IsColumnVisible("status"))
				{
					<TemplateColumn T="BotVM">
						<HeaderTemplate>
							Status
						</HeaderTemplate>
						<CellTemplate>
							@{
								var botKey = context.Item?.Key;
								var status = botKey != null ? GetBotStatus(botKey) : null;
							}
							@if (status != null)
							{
								var statusColor = GetStatusColor(status.State);
								var statusIcon = GetStatusIcon(status.State);
								@if (status.State == RealtimeBotState.Faulted && !string.IsNullOrEmpty(status.ErrorMessage))
								{
									<MudTooltip Text="@status.ErrorMessage" Placement="Placement.Top">
										<MudChip T="string" Size="Size.Small" Color="statusColor" Icon="@statusIcon" OnClick="@(() => ShowErrorDialog(botKey!, status.ErrorMessage!))">
											@status.State.ToString()
										</MudChip>
									</MudTooltip>
								}
								else
								{
									<MudChip T="string" Size="Size.Small" Color="statusColor" Icon="@statusIcon">
										@status.State.ToString()
									</MudChip>
								}
								@if (status.State == RealtimeBotState.CatchingUp)
								{
									<MudText Typo="Typo.caption" Class="ml-1">@status.BarsCaughtUp bars</MudText>
								}
								@if (status.LastBarTime != null)
								{
									<MudText Typo="Typo.caption" Class="ml-1" Style="color: gray;">@status.LastBarTime.Value.ToString("HH:mm:ss")</MudText>
								}
							}
							else if (context.Item?.Value?.Enabled == true)
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.HourglassEmpty">
									Loading...
								</MudChip>
							}
							else
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Default" Icon="@Icons.Material.Filled.Stop">
									Stopped
								</MudChip>
							}
						</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("enabled"))
				{
					<TemplateColumn T="BotVM">
						<HeaderTemplate>
							Enabled
						</HeaderTemplate>
						<CellTemplate>
							@if (context.Item?.Value != null)
							{
								var isInProgress = operationsInProgress.Contains(context.Item.Key);
								<div>
									<MudSwitch T="bool"
										Value="@context.Item.Value.Enabled"
										ValueChanged="@((bool enabled) => ToggleBotEnabledAsync(context.Item.Key, context.Item.Value, enabled))"
										Color="Color.Primary"
										ThumbIcon="@Icons.Material.Filled.Radar"
										Size="Size.Small"
										Disabled="@isInProgress" />
								</div>
							}
						</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("live"))
				{
					<TemplateColumn T="BotVM">
						<HeaderTemplate>
							Live
						</HeaderTemplate>
						<CellTemplate>
							@if (context.Item?.Value != null)
							{
								<div>
									<MudSwitch T="bool" ThumbIcon="@Icons.Material.Rounded.AttachMoney" @bind-Value="context.Item.Value.Live" Color=@((context.Item.IsLive ? Color.Secondary : Color.Default)) Size="Size.Small"></MudSwitch>
								</div>
							}
						</CellTemplate>
					</TemplateColumn>
				}

				@if (IsColumnVisible("exchange"))
				{
					<TemplateColumn T="BotVM" Title="Exchange">
						<CellTemplate>@context.Item?.Value?.Exchange</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("area"))
				{
					<TemplateColumn T="BotVM" Title="Area">
						<CellTemplate>@context.Item?.Value?.ExchangeArea</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("symbol"))
				{
					<TemplateColumn T="BotVM" Title="Symbol">
						<CellTemplate>@context.Item?.Value?.Symbol</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("timeframe"))
				{
					<TemplateColumn T="BotVM" Title="TimeFrame">
						<CellTemplate>@context.Item?.Value?.TimeFrame</CellTemplate>
					</TemplateColumn>
				}

				@if (IsColumnVisible("type"))
				{
					<TemplateColumn T="BotVM" Title="Type">
						<CellTemplate>@context.Item?.Value?.BotTypeName</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("name"))
				{
					<TemplateColumn T="BotVM" Title="Name">
						<CellTemplate>
							@if (context.Item?.Key != null)
							{
								<MudLink Href="@($"/workbench/bot/{context.Item.Key}")">@(context.Item.Value?.Name ?? context.Item.Key)</MudLink>
							}
							else
							{
								@context.Item?.Value?.Name
							}
						</CellTemplate>
					</TemplateColumn>
				}

				@* Equity Columns *@
				@if (IsColumnVisible("equity"))
				{
					<TemplateColumn T="BotVM" Title="Equity">
						<CellTemplate>
							@{
								var botKey = context.Item?.Key;
								var accountStatus = botKey != null ? GetAccountStatus(botKey) : null;
							}
							@if (accountStatus != null)
							{
								<MudText>@accountStatus.Equity.ToString("N2")</MudText>
							}
							else
							{
								<MudText Color="Color.Tertiary">--</MudText>
							}
						</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("eq-all-time"))
				{
					<TemplateColumn T="BotVM" Title="%Eq All">
						<HeaderTemplate>
							<MudTooltip Text="Equity change % all time (requires equity history tracking)">
								<MudText>%Eq All</MudText>
							</MudTooltip>
						</HeaderTemplate>
						<CellTemplate>
							@{
								var eqChange = GetEquityChange(context.Item?.Key, EquityPeriod.AllTime);
							}
							@if (eqChange.HasValue)
							{
								var color = eqChange.Value >= 0 ? Color.Success : Color.Error;
								<MudText Color="@color">@(eqChange.Value >= 0 ? "+" : "")@eqChange.Value.ToString("P2")</MudText>
							}
							else
							{
								<MudTooltip Text="Equity history tracking not yet implemented">
									<MudText Color="Color.Tertiary">--</MudText>
								</MudTooltip>
							}
						</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("eq-30d"))
				{
					<TemplateColumn T="BotVM" Title="%Eq 30d">
						<HeaderTemplate>
							<MudTooltip Text="Equity change % last 30 days">
								<MudText>%Eq 30d</MudText>
							</MudTooltip>
						</HeaderTemplate>
						<CellTemplate>
							@{
								var eqChange = GetEquityChange(context.Item?.Key, EquityPeriod.Last30Days);
							}
							@if (eqChange.HasValue)
							{
								var color = eqChange.Value >= 0 ? Color.Success : Color.Error;
								<MudText Color="@color">@(eqChange.Value >= 0 ? "+" : "")@eqChange.Value.ToString("P2")</MudText>
							}
							else
							{
								<MudTooltip Text="Equity history tracking not yet implemented">
									<MudText Color="Color.Tertiary">--</MudText>
								</MudTooltip>
							}
						</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("eq-7d"))
				{
					<TemplateColumn T="BotVM" Title="%Eq 7d">
						<HeaderTemplate>
							<MudTooltip Text="Equity change % last 7 days">
								<MudText>%Eq 7d</MudText>
							</MudTooltip>
						</HeaderTemplate>
						<CellTemplate>
							@{
								var eqChange = GetEquityChange(context.Item?.Key, EquityPeriod.Last7Days);
							}
							@if (eqChange.HasValue)
							{
								var color = eqChange.Value >= 0 ? Color.Success : Color.Error;
								<MudText Color="@color">@(eqChange.Value >= 0 ? "+" : "")@eqChange.Value.ToString("P2")</MudText>
							}
							else
							{
								<MudTooltip Text="Equity history tracking not yet implemented">
									<MudText Color="Color.Tertiary">--</MudText>
								</MudTooltip>
							}
						</CellTemplate>
					</TemplateColumn>
				}
				@if (IsColumnVisible("eq-1d"))
				{
					<TemplateColumn T="BotVM" Title="%Eq 1d">
						<HeaderTemplate>
							<MudTooltip Text="Equity change % last 24 hours">
								<MudText>%Eq 1d</MudText>
							</MudTooltip>
						</HeaderTemplate>
						<CellTemplate>
							@{
								var eqChange = GetEquityChange(context.Item?.Key, EquityPeriod.Last1Day);
							}
							@if (eqChange.HasValue)
							{
								var color = eqChange.Value >= 0 ? Color.Success : Color.Error;
								<MudText Color="@color">@(eqChange.Value >= 0 ? "+" : "")@eqChange.Value.ToString("P2")</MudText>
							}
							else
							{
								<MudTooltip Text="Equity history tracking not yet implemented">
									<MudText Color="Color.Tertiary">--</MudText>
								</MudTooltip>
							}
						</CellTemplate>
					</TemplateColumn>
				}

				@if (IsColumnVisible("ad"))
				{
					<PropertyColumn Property="x => x.AD" Title="AD" T="BotVM" TProperty="double?" />
				}
				@if (IsColumnVisible("comments"))
				{
					<TemplateColumn T="BotVM" Title="Comments">
						<CellTemplate>@context.Item?.Value?.Comments</CellTemplate>
					</TemplateColumn>
				}
			</Columns>
			<ChildRowContent>
				@if (context.Item?.Value != null)
				{
					<MudCard>
						<MudCardHeader>
							<CardHeaderContent>
								<MudText Typo="Typo.h6">@context.Item.Value.Name</MudText>
							</CardHeaderContent>
						</MudCardHeader>
						<MudCardContent>
							<MudText>Enabled: <MudSwitch T="bool" @bind-Value="context.Item.Value.Enabled">Enabled</MudSwitch></MudText>
							<MudText>Comments: @context.Item.Value.Comments</MudText>
						</MudCardContent>
					</MudCard>
				}
			</ChildRowContent>
			<ContextMenu>
				<MudMenuItem Icon="@Icons.Material.Filled.Delete">
					Delete @context?.Value?.Name
				</MudMenuItem>
			</ContextMenu>
		</ObservableDataView>

		@* Display bots that failed to load *@
		@if (LoadFailures.Any())
		{
			<MudDivider Class="my-4" />
			<MudText Typo="Typo.h6" Color="Color.Error" Class="mb-2">
				<MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" />
				Failed to Load (@LoadFailures.Count)
			</MudText>
			<MudAlert Severity="Severity.Warning" Class="mb-2">
				The following bot IDs are in this portfolio but could not be loaded from disk.
				They may have been deleted or moved.
			</MudAlert>
			<MudTable Items="@LoadFailures" Dense="true" Hover="true">
				<HeaderContent>
					<MudTh>Bot ID</MudTh>
					<MudTh>Error</MudTh>
					<MudTh>Actions</MudTh>
				</HeaderContent>
				<RowTemplate>
					<MudTd DataLabel="Bot ID">
						<MudText Color="Color.Error">@context.BotId</MudText>
					</MudTd>
					<MudTd DataLabel="Error">@context.ErrorMessage</MudTd>
					<MudTd DataLabel="Actions">
						<MudButton Variant="Variant.Text"
								   Color="Color.Error"
								   Size="Size.Small"
								   StartIcon="@Icons.Material.Filled.RemoveCircle"
								   OnClick="@(() => RemoveFailedBot(context.BotId))">
							Remove from Portfolio
						</MudButton>
					</MudTd>
				</RowTemplate>
			</MudTable>
		}
	}
	else
	{
		<MudProgressCircular Indeterminate="true" />
		<MudText>Loading bots...</MudText>
	}
</div>

@code {
	// User-level services (for workspaces, bots)
	[CascadingParameter(Name = "UserServices")]
	public IServiceProvider? UserServices { get; set; }

	// Workspace-level services (for portfolios)
	[CascadingParameter(Name = "WorkspaceServices")]
	public IServiceProvider? WorkspaceServices { get; set; }

	// Portfolio ID from layout (stateful navigation)
	[CascadingParameter(Name = "PortfolioId")]
	public string? CascadedPortfolioId { get; set; }

	// Portfolio ID from query string (direct links/bookmarks)
	[Parameter]
	[SupplyParameterFromQuery(Name = "portfolio")]
	public string? QueryPortfolioId { get; set; }

	// Resolved portfolio (query wins if present)
	private string? EffectivePortfolioId => QueryPortfolioId ?? CascadedPortfolioId;

	private Portfolio2? CurrentPortfolio { get; set; }

	private PortfolioFilteredBotCache? FilteredBotCache { get; set; }

	ObservableDataView<string, BotEntity, BotVM>? ItemsEditor { get; set; }

	[Inject]
	private ILogger<Bots>? Logger { get; set; }

	[Inject]
	private IServiceProvider? ServiceProvider { get; set; }

	// Orleans cluster client - fetched from services if available (optional)
	private IClusterClient? ClusterClient { get; set; }
	private bool clusterClientChecked = false;

	/// <summary>
	/// List of bots that failed to load (for display in the UI).
	/// </summary>
	private List<BotLoadFailure> LoadFailures { get; set; } = new();

	private IDisposable? loadFailuresSubscription;

	// Harness status tracking
	private Dictionary<string, RealtimeBotStatus> botStatuses = new();
	private HashSet<string> operationsInProgress = new();
	private System.Timers.Timer? statusPollingTimer;

	private IClusterClient? GetClusterClient()
	{
		if (!clusterClientChecked && ServiceProvider != null)
		{
			clusterClientChecked = true;
			try
			{
				ClusterClient = ServiceProvider.GetService<IClusterClient>();
				if (ClusterClient == null)
				{
					Logger?.LogWarning("[Bots] IClusterClient not available - harness control will be disabled");
				}
			}
			catch (Exception ex)
			{
				Logger?.LogWarning(ex, "[Bots] Failed to get IClusterClient - harness control will be disabled");
			}
		}
		return ClusterClient;
	}

	protected override async Task OnParametersSetAsync()
	{
		var portfolioId = EffectivePortfolioId;
		Logger?.LogDebug("[Bots] OnParametersSetAsync - PortfolioId={PortfolioId}, WorkspaceServices={WS}, UserServices={US}",
			portfolioId, WorkspaceServices != null ? "set" : "null", UserServices != null ? "set" : "null");

		if (string.IsNullOrEmpty(portfolioId))
		{
			Logger?.LogInformation("[Bots] No portfolio selected");
			CurrentPortfolio = null;
			FilteredBotCache?.Dispose();
			FilteredBotCache = null;
			return;
		}

		if (WorkspaceServices == null)
		{
			Logger?.LogWarning("[Bots] WorkspaceServices not available - layout may not be fully initialized yet");
			CurrentPortfolio = null;
			FilteredBotCache?.Dispose();
			FilteredBotCache = null;
			return;
		}

		if (UserServices == null)
		{
			Logger?.LogWarning("[Bots] UserServices not available - layout may not be fully initialized yet");
			CurrentPortfolio = null;
			FilteredBotCache?.Dispose();
			FilteredBotCache = null;
			return;
		}

		// Load portfolio from workspace
		var portfolioReader = WorkspaceServices.GetService<IObservableReader<string, Portfolio2>>();
		if (portfolioReader == null)
		{
			Logger?.LogWarning("[Bots] Portfolio reader not available from WorkspaceServices - workspace may not be fully initialized yet");
			CurrentPortfolio = null;
			FilteredBotCache?.Dispose();
			FilteredBotCache = null;
			return;
		}
		Logger?.LogDebug("[Bots] PortfolioReader available with {Count} values", portfolioReader.Values.Count);

		var portfolioOptional = portfolioReader.Values.Lookup(portfolioId);
		if (!portfolioOptional.HasValue)
		{
			Logger?.LogWarning("Portfolio '{PortfolioId}' not found", portfolioId);
			CurrentPortfolio = null;
			FilteredBotCache?.Dispose();
			FilteredBotCache = null;
			return;
		}

		var innerOptional = portfolioOptional.Value;
		if (!innerOptional.HasValue)
		{
			Logger?.LogWarning("Portfolio '{PortfolioId}' not loaded", portfolioId);
			CurrentPortfolio = null;
			FilteredBotCache?.Dispose();
			FilteredBotCache = null;
			return;
		}

		if (CurrentPortfolio != innerOptional.Value)
		{
			CurrentPortfolio = innerOptional.Value;
			Logger?.LogInformation("Loaded portfolio '{PortfolioName}' with {BotCount} bots",
				CurrentPortfolio.Name, CurrentPortfolio.BotIds?.Count ?? 0);

			// Get ALL user bots
			var botReader = UserServices.GetService<IObservableReader<string, BotEntity>>();
			if (botReader == null)
			{
				Logger?.LogError("[Bots] Bot reader (IObservableReader<string, BotEntity>) not available from UserServices. Check that TradingLayoutVM.ConfigureUserServices is calling UserBotsX.AddUserBots");
				CurrentPortfolio = null;
				FilteredBotCache?.Dispose();
				FilteredBotCache = null;
				return;
			}
			Logger?.LogDebug("[Bots] BotReader available with {Count} keys", botReader.Keys.Count);

			// Filter to only bots in this portfolio
			loadFailuresSubscription?.Dispose();
			FilteredBotCache?.Dispose();
			FilteredBotCache = new PortfolioFilteredBotCache(botReader, CurrentPortfolio);

			// Subscribe to load failures to update UI
			loadFailuresSubscription = FilteredBotCache.LoadFailures.Connect()
				.ToCollection()
				.Subscribe(failures =>
				{
					LoadFailures = failures.ToList();
					InvokeAsync(StateHasChanged);
				});

			// Load all values for the portfolio's bots (they're lazy-loaded by default)
			Logger?.LogInformation($"[Bots] Calling ListenAllValues on FilteredBotCache");
			await FilteredBotCache.ListenAllValues();

			// WORKAROUND: Manually trigger loading of all bot values since ListenAllValues doesn't load existing values
			// Subscribe to each bot's value observable to trigger the lazy loading
			var keys = FilteredBotCache.Keys.Items.ToList();
			Logger?.LogInformation($"[Bots] FilteredBotCache has {keys.Count} keys. Subscribing to value observables...");

			foreach (var key in keys)
			{
				Logger?.LogDebug($"[Bots] Subscribing to value observable for bot key: {key}");
				_ = FilteredBotCache.GetValueObservable(key).Subscribe(x =>
				{
					Debug.WriteLine("DISCARDING New bot value: " + key + " " + x);
				});
			}

			Logger?.LogInformation($"[Bots] Finished subscribing to {keys.Count} bot value observables");

			// Start polling for harness status
			StartStatusPolling();

			// Do initial status poll
			await PollBotStatusesAsync();
			await PollAccountStatusesAsync();

			// Load column preferences
			await LoadColumnPreferencesAsync();
		}

		await base.OnParametersSetAsync();
	}

	public void Dispose()
	{
		StopStatusPolling();
		loadFailuresSubscription?.Dispose();
		FilteredBotCache?.Dispose();
	}

	private void RemoveFailedBot(string botId)
	{
		if (FilteredBotCache?.RemoveFailedBot(botId) == true)
		{
			Logger?.LogInformation("Removed failed bot '{BotId}' from portfolio", botId);
		}
	}

	#region Harness Control

	private void StartStatusPolling()
	{
		// Only start polling if we have Orleans client
		if (GetClusterClient() == null)
		{
			Logger?.LogDebug("[Bots] IClusterClient not available - status polling disabled");
			return;
		}

		if (statusPollingTimer == null)
		{
			statusPollingTimer = new System.Timers.Timer(3000); // Poll every 3 seconds
			statusPollingTimer.Elapsed += OnStatusPollTimer;
			statusPollingTimer.Start();
			Logger?.LogDebug("[Bots] Started status polling timer");
		}
	}

	private void StopStatusPolling()
	{
		if (statusPollingTimer != null)
		{
			statusPollingTimer.Stop();
			statusPollingTimer.Elapsed -= OnStatusPollTimer;
			statusPollingTimer.Dispose();
			statusPollingTimer = null;
			Logger?.LogDebug("[Bots] Stopped status polling timer");
		}
	}

	private async void OnStatusPollTimer(object? sender, ElapsedEventArgs e)
	{
		await InvokeAsync(async () =>
		{
			await PollBotStatusesAsync();
			await PollAccountStatusesAsync();
			StateHasChanged();
		});
	}

	private async Task PollBotStatusesAsync()
	{
		var client = GetClusterClient();
		if (client == null || FilteredBotCache == null) return;

		var keys = FilteredBotCache.Keys.Items.ToList();
		foreach (var botId in keys)
		{
			try
			{
				var grain = client.GetGrain<IRealtimeBotHarnessG>(botId);
				var status = await grain.GetStatus();
				botStatuses[botId] = status;
			}
			catch (Exception ex)
			{
				Logger?.LogDebug("[Bots] Failed to get status for {BotId}: {Message}", botId, ex.Message);
			}
		}
	}

	private RealtimeBotStatus? GetBotStatus(string botId)
	{
		return botStatuses.TryGetValue(botId, out var status) ? status : null;
	}

	private Color GetStatusColor(RealtimeBotState state)
	{
		return state switch
		{
			RealtimeBotState.Running => Color.Success,
			RealtimeBotState.CatchingUp => Color.Warning,
			RealtimeBotState.Starting => Color.Info,
			RealtimeBotState.Faulted => Color.Error,
			RealtimeBotState.Stopped => Color.Default,
			_ => Color.Default
		};
	}

	private string GetStatusIcon(RealtimeBotState state)
	{
		return state switch
		{
			RealtimeBotState.Running => Icons.Material.Filled.CheckCircle,
			RealtimeBotState.CatchingUp => Icons.Material.Filled.Sync,
			RealtimeBotState.Starting => Icons.Material.Filled.HourglassEmpty,
			RealtimeBotState.Faulted => Icons.Material.Filled.Error,
			RealtimeBotState.Stopped => Icons.Material.Filled.Stop,
			_ => Icons.Material.Filled.Help
		};
	}

	private async Task ToggleBotEnabledAsync(string botId, BotEntity bot, bool enabled)
	{
		var client = GetClusterClient();

		// If no Orleans client, just update the local state
		if (client == null)
		{
			Logger?.LogDebug("[Bots] ClusterClient not available - updating local state only");
			bot.Enabled = enabled;
			StateHasChanged();
			return;
		}

		operationsInProgress.Add(botId);
		StateHasChanged();

		try
		{
			var grain = client.GetGrain<IRealtimeBotHarnessG>(botId);

			if (enabled)
			{
				Logger?.LogInformation("[Bots] Enabling bot {BotId} - starting harness", botId);

				var config = CreateConfiguration(botId, bot);
				var validationResult = config.Validate();

				if (!validationResult.IsValid)
				{
					Logger?.LogError("[Bots] Bot {BotId} configuration is invalid: {Errors}",
						botId, string.Join("; ", validationResult.Errors));
					return;
				}

				var result = await grain.Start(config);
				if (result)
				{
					bot.Enabled = true;
					Logger?.LogInformation("[Bots] Bot {BotId} harness started successfully", botId);
				}
				else
				{
					Logger?.LogWarning("[Bots] Bot {BotId} harness Start() returned false - may already be running", botId);
					bot.Enabled = true; // Still set enabled since it might already be running
				}
			}
			else
			{
				Logger?.LogInformation("[Bots] Disabling bot {BotId} - stopping harness", botId);
				await grain.Stop();
				bot.Enabled = false;
				Logger?.LogInformation("[Bots] Bot {BotId} harness stopped successfully", botId);
			}

			// Refresh status
			try
			{
				var status = await grain.GetStatus();
				botStatuses[botId] = status;
			}
			catch { /* ignore status fetch errors */ }
		}
		catch (Exception ex)
		{
			Logger?.LogError(ex, "[Bots] Failed to toggle bot {BotId} enabled state", botId);
		}
		finally
		{
			operationsInProgress.Remove(botId);
			StateHasChanged();
		}
	}

	private RealtimeBotConfiguration CreateConfiguration(string botId, BotEntity bot)
	{
		var config = new RealtimeBotConfiguration
		{
			BotTypeName = bot.BotTypeName ?? string.Empty,
			AccountId = $"{bot.Exchange}.{bot.ExchangeArea}:default",
			Parameters = new Dictionary<string, object>()
		};

		// Add primary market subscription
		if (!string.IsNullOrEmpty(bot.Symbol) && bot.TimeFrame != null)
		{
			config.Markets.Add(new MarketSubscription
			{
				Exchange = bot.Exchange ?? "binance",
				ExchangeArea = bot.ExchangeArea ?? "futures",
				Symbol = bot.Symbol,
				TimeFrame = bot.TimeFrame.ToShortString()
			});
		}

		return config;
	}

	private async Task ShowErrorDialog(string botId, string errorMessage)
	{
		var parameters = new DialogParameters<BotErrorDialog>
		{
			{ x => x.BotId, botId },
			{ x => x.ErrorMessage, errorMessage }
		};

		var options = new DialogOptions
		{
			CloseButton = true,
			MaxWidth = MaxWidth.Medium,
			FullWidth = true
		};

		await DialogService.ShowAsync<BotErrorDialog>("Bot Error Details", parameters, options);
	}

	#endregion

	#region Add Bot

	private async Task AddBotAsync()
	{
		if (FilteredBotCache == null)
		{
			Logger?.LogWarning("[Bots] Cannot add bot - FilteredBotCache is null");
			return;
		}

		// Get available bot types from registry
		var botTypes = BotTypeRegistry.PBotRegistry.Names.Keys
			.OrderBy(n => n)
			.ToList();

		if (!botTypes.Any())
		{
			Logger?.LogWarning("[Bots] No bot types registered in BotTypeRegistry");
			await DialogService.ShowMessageBox(
				"No Bot Types",
				"No bot types are registered. Please ensure bot assemblies are loaded.",
				yesText: "OK");
			return;
		}

		var result = await AddBotDialog.ShowAsync(DialogService, botTypes);

		if (result == null)
		{
			Logger?.LogDebug("[Bots] Add bot dialog cancelled");
			return;
		}

		try
		{
			var key = result.GenerateKey();
			var botEntity = result.ToBotEntity();

			Logger?.LogInformation("[Bots] Creating new bot '{Key}' of type '{BotType}'", key, result.BotTypeName);

			await FilteredBotCache.Write(key, botEntity);

			Logger?.LogInformation("[Bots] Bot '{Key}' created successfully", key);
		}
		catch (Exception ex)
		{
			Logger?.LogError(ex, "[Bots] Failed to create bot");
			await DialogService.ShowMessageBox(
				"Error",
				$"Failed to create bot: {ex.Message}",
				yesText: "OK");
		}
	}

	#endregion

	#region Column Visibility

	private const string ViewId = "bots-list";

	/// <summary>
	/// Column definition for UI display and visibility management.
	/// </summary>
	public record ColumnDefinition(string Id, string Name, bool DefaultVisible = true);

	/// <summary>
	/// All available columns with their default visibility.
	/// </summary>
	private static readonly List<ColumnDefinition> ColumnDefinitions = new()
	{
		new("status", "Status", true),
		new("enabled", "Enabled", true),
		new("live", "Live", true),
		new("exchange", "Exchange", false),
		new("area", "Area", false),
		new("symbol", "Symbol", true),
		new("timeframe", "TimeFrame", true),
		new("type", "Type", true),
		new("name", "Name", true),
		new("equity", "Equity", true),
		new("eq-all-time", "%Eq All Time", false),
		new("eq-30d", "%Eq 30d", false),
		new("eq-7d", "%Eq 7d", false),
		new("eq-1d", "%Eq 1d", true),
		new("ad", "AD", false),
		new("comments", "Comments", false),
	};

	/// <summary>
	/// Current column visibility state (column ID -> visible).
	/// </summary>
	private Dictionary<string, bool> columnVisibility = new();

	/// <summary>
	/// Whether column preferences have been loaded from the grain.
	/// </summary>
	private bool preferencesLoaded = false;

	/// <summary>
	/// Checks if a column is visible.
	/// </summary>
	private bool IsColumnVisible(string columnId)
	{
		if (columnVisibility.TryGetValue(columnId, out var visible))
		{
			return visible;
		}

		// Default visibility from definition
		var def = ColumnDefinitions.FirstOrDefault(c => c.Id == columnId);
		return def?.DefaultVisible ?? true;
	}

	/// <summary>
	/// Toggles column visibility and saves preferences.
	/// </summary>
	private async Task ToggleColumnVisibility(string columnId)
	{
		var currentVisible = IsColumnVisible(columnId);
		columnVisibility[columnId] = !currentVisible;

		Logger?.LogDebug("[Bots] Toggled column '{ColumnId}' visibility to {Visible}", columnId, !currentVisible);

		// Save to preferences grain
		await SaveColumnPreferencesAsync();
		StateHasChanged();
	}

	/// <summary>
	/// Resets all columns to their default visibility.
	/// </summary>
	private async Task ResetColumnVisibility()
	{
		columnVisibility.Clear();
		Logger?.LogInformation("[Bots] Reset column visibility to defaults");

		// Clear preferences in grain
		var client = GetClusterClient();
		if (client != null)
		{
			try
			{
				var grain = client.GetGrain<IUserPreferencesG>("Anonymous");
				await grain.ClearColumnPreferences(ViewId);
			}
			catch (Exception ex)
			{
				Logger?.LogWarning(ex, "[Bots] Failed to clear column preferences in grain");
			}
		}

		StateHasChanged();
	}

	/// <summary>
	/// Loads column preferences from the user preferences grain.
	/// </summary>
	private async Task LoadColumnPreferencesAsync()
	{
		if (preferencesLoaded) return;

		var client = GetClusterClient();
		if (client == null)
		{
			Logger?.LogDebug("[Bots] ClusterClient not available - using default column visibility");
			preferencesLoaded = true;
			return;
		}

		try
		{
			var grain = client.GetGrain<IUserPreferencesG>("Anonymous");
			var preferences = await grain.GetColumnPreferences(ViewId);

			if (preferences != null)
			{
				columnVisibility = new Dictionary<string, bool>(preferences.ColumnVisibility);
				Logger?.LogInformation("[Bots] Loaded column preferences with {Count} columns", preferences.ColumnVisibility.Count);
			}
			else
			{
				Logger?.LogDebug("[Bots] No saved column preferences - using defaults");
			}
		}
		catch (Exception ex)
		{
			Logger?.LogWarning(ex, "[Bots] Failed to load column preferences from grain");
		}

		preferencesLoaded = true;
	}

	/// <summary>
	/// Saves column preferences to the user preferences grain.
	/// </summary>
	private async Task SaveColumnPreferencesAsync()
	{
		var client = GetClusterClient();
		if (client == null)
		{
			Logger?.LogDebug("[Bots] ClusterClient not available - column preferences not saved");
			return;
		}

		try
		{
			var grain = client.GetGrain<IUserPreferencesG>("Anonymous");
			var preferences = new ColumnPreferences
			{
				ColumnVisibility = new Dictionary<string, bool>(columnVisibility)
			};
			await grain.SetColumnPreferences(ViewId, preferences);
			Logger?.LogDebug("[Bots] Saved column preferences");
		}
		catch (Exception ex)
		{
			Logger?.LogWarning(ex, "[Bots] Failed to save column preferences to grain");
		}
	}

	#endregion

	#region Account Status and Equity

	/// <summary>
	/// Periods for equity change calculation.
	/// </summary>
	private enum EquityPeriod
	{
		AllTime,
		Last30Days,
		Last7Days,
		Last1Day
	}

	/// <summary>
	/// Cached account statuses from bot grains.
	/// </summary>
	private Dictionary<string, BotAccountStatus> accountStatuses = new();

	/// <summary>
	/// Gets the account status for a bot.
	/// </summary>
	private BotAccountStatus? GetAccountStatus(string? botId)
	{
		if (string.IsNullOrEmpty(botId)) return null;
		return accountStatuses.TryGetValue(botId, out var status) ? status : null;
	}

	/// <summary>
	/// Gets the equity change for a bot over a specified period.
	/// </summary>
	/// <remarks>
	/// Currently returns null as equity history tracking is not yet implemented.
	/// Future: Will calculate % change from historical equity snapshots stored in binary files.
	/// </remarks>
	private double? GetEquityChange(string? botId, EquityPeriod period)
	{
		// TODO: Implement equity history tracking
		// This will require:
		// 1. Periodic equity snapshots stored in HLC binary format with YAML frontmatter
		// 2. Loading historical equity data for the specified period
		// 3. Calculating % change from first value in period to current equity
		return null;
	}

	/// <summary>
	/// Polls account statuses along with bot statuses.
	/// </summary>
	private async Task PollAccountStatusesAsync()
	{
		var client = GetClusterClient();
		if (client == null || FilteredBotCache == null) return;

		var keys = FilteredBotCache.Keys.Items.ToList();
		foreach (var botId in keys)
		{
			try
			{
				var grain = client.GetGrain<IRealtimeBotHarnessG>(botId);
				var accountStatus = await grain.GetAccountStatus();
				if (accountStatus != null)
				{
					accountStatuses[botId] = accountStatus;
				}
			}
			catch (Exception ex)
			{
				Logger?.LogDebug("[Bots] Failed to get account status for {BotId}: {Message}", botId, ex.Message);
			}
		}
	}

	#endregion

	protected override async Task OnInitializedAsync()
	{
		await LoadColumnPreferencesAsync();
		await base.OnInitializedAsync();
	}
}
