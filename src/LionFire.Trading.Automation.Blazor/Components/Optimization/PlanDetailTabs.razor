@namespace LionFire.Trading.Automation.Blazor.Components.Optimization
@using LionFire.Trading.Optimization.Plans
@using LionFire.Trading.Optimization.Execution
@using LionFire.Trading.Automation.Optimization.Prioritization
@using LionFire.Trading.Automation.Blazor.Optimization.Matrix

<MudPaper Class="plan-detail-tabs" Elevation="1">
    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" ActivePanelIndex="2">
        <MudTabPanel Icon="@Icons.Material.Filled.Info" ToolTip="Overview">
            <PlanOverviewTab Plan="@Plan" ExecutionState="@ExecutionState"
                             OnStartExecution="@OnStartExecution"
                             OnStopExecution="@OnStopExecution"
                             OnPauseExecution="@OnPauseExecution"
                             OnResumeExecution="@OnResumeExecution"
                             NextBestJob="@NextBestJob" />
        </MudTabPanel>

        <MudTabPanel Text="Jobs" Icon="@Icons.Material.Filled.List" Disabled="@(ExecutionState == null)">
            <PlanJobsTab ExecutionState="@ExecutionState"
                         OnRetryFailed="@OnRetryFailed"
                         RankedJobs="@RankedJobs" />
        </MudTabPanel>

        <MudTabPanel Text="Matrix" Icon="@Icons.Material.Filled.GridOn">
            <OptimizationMatrixDashboard Plan="@Plan" />
        </MudTabPanel>

        <MudTabPanel Text="Results" Icon="@Icons.Material.Filled.Analytics" Disabled="@(!HasResults)">
            <PlanResultsTab ExecutionState="@ExecutionState" />
        </MudTabPanel>

        <MudTabPanel Text="History" Icon="@Icons.Material.Filled.History" Disabled="@(!HasHistory)">
            <PlanHistoryTab RunHistory="@ExecutionState?.RunHistory"
                            OnRerun="@OnRerunHistory"
                            OnDelete="@OnDeleteHistory" />
        </MudTabPanel>

        <MudTabPanel Text="Settings" Icon="@Icons.Material.Filled.Settings">
            <PlanSettingsTab Plan="@Plan" />
        </MudTabPanel>
    </MudTabs>
</MudPaper>

<style>
    .plan-detail-tabs {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .plan-detail-tabs .mud-tabs {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .plan-detail-tabs .mud-tabs-panels {
        flex: 1;
        overflow-y: auto;
    }
</style>

@code {
    [Parameter] public OptimizationPlan Plan { get; set; } = default!;
    [Parameter] public PlanExecutionState? ExecutionState { get; set; }
    [Parameter] public EventCallback<(int workers, bool usePrioritization)> OnStartExecution { get; set; }
    [Parameter] public EventCallback OnStopExecution { get; set; }
    [Parameter] public EventCallback OnPauseExecution { get; set; }
    [Parameter] public EventCallback OnResumeExecution { get; set; }
    [Parameter] public EventCallback OnRetryFailed { get; set; }
    [Parameter] public EventCallback<PlanRunHistory> OnRerunHistory { get; set; }
    [Parameter] public EventCallback<PlanRunHistory> OnDeleteHistory { get; set; }
    [Parameter] public NextJobRecommendation? NextBestJob { get; set; }
    [Parameter] public IReadOnlyList<RankedJob>? RankedJobs { get; set; }

    private bool HasResults => ExecutionState?.CompletedJobs > 0;
    private bool HasHistory => ExecutionState?.RunHistory?.Count > 0;
}
