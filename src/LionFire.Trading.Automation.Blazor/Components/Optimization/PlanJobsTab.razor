@namespace LionFire.Trading.Automation.Blazor.Components.Optimization
@using LionFire.Trading.Optimization.Execution
@using LionFire.Trading.Optimization.Matrix
@using LionFire.Trading.Automation.Optimization.Matrix
@using LionFire.Trading.Automation.Optimization.Prioritization
@inject IJobRunner JobRunner
@inject IPlanMatrixService MatrixService
@inject NavigationManager Navigation

<div class="plan-jobs-tab">
    @if (ExecutionState == null)
    {
        <MudText Typo="Typo.body1" Class="mud-text-secondary text-center pa-8">
            Start execution to see job details
        </MudText>
    }
    else
    {
        @* Summary Cards *@
        <div class="job-summary mb-4">
            <MudPaper Class="summary-card" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h4" Color="Color.Primary">@ExecutionState.TotalJobs</MudText>
                <MudText Typo="Typo.caption">Total Jobs</MudText>
            </MudPaper>
            <MudPaper Class="summary-card" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h4" Color="Color.Success">@ExecutionState.CompletedJobs</MudText>
                <MudText Typo="Typo.caption">Completed</MudText>
            </MudPaper>
            <MudPaper Class="summary-card" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h4" Color="Color.Warning">@(ExecutionState.TotalJobs - ExecutionState.CompletedJobs - ExecutionState.FailedJobs)</MudText>
                <MudText Typo="Typo.caption">Pending</MudText>
            </MudPaper>
            <MudPaper Class="summary-card" Elevation="0" Outlined="true">
                <MudText Typo="Typo.h4" Color="Color.Error">@ExecutionState.FailedJobs</MudText>
                <MudText Typo="Typo.caption">Failed</MudText>
            </MudPaper>
            @if (ExecutionState.UsePrioritization)
            {
                <MudPaper Class="summary-card" Elevation="0" Outlined="true">
                    <MudText Typo="Typo.h4" Color="Color.Info">@ExecutionState.PrioritizedJobsExecuted</MudText>
                    <MudText Typo="Typo.caption">Prioritized</MudText>
                </MudPaper>
                @if (ExecutionState.FollowUpJobsQueued > 0)
                {
                    <MudPaper Class="summary-card" Elevation="0" Outlined="true">
                        <MudText Typo="Typo.h4" Color="Color.Tertiary">@ExecutionState.FollowUpJobsQueued</MudText>
                        <MudText Typo="Typo.caption">Follow-ups</MudText>
                    </MudPaper>
                }
            }
        </div>

        @* Running Jobs Section *@
        @if (GetRunningJobs().ToList() is { Count: > 0 } runningJobs)
        {
            <MudCard Class="mb-4" Elevation="0" Outlined="true">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Info">
                            <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Class="mr-1" />
                            Running Jobs (@runningJobs.Count)
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudSimpleTable Dense="true" Hover="true">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Timeframe</th>
                                <th>Date Range</th>
                                <th style="text-align: right;">Progress</th>
                                <th style="text-align: right;">Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var job in runningJobs)
                            {
                                <tr @ondblclick="@(() => NavigateToJobDetail(job))" style="cursor: pointer;">
                                    <td>@job.Symbol</td>
                                    <td>@job.Timeframe</td>
                                    <td>@job.StartDate.ToString("yyyy-MM-dd") - @job.EndDate.ToString("yyyy-MM-dd")</td>
                                    <td style="text-align: right; min-width: 120px;">
                                        @{
                                            var progress = GetJobProgress(job);
                                        }
                                        @if (progress != null)
                                        {
                                            <div class="d-flex align-center gap-2">
                                                <MudProgressLinear Value="@(progress.Value * 100)" Size="Size.Small" Color="Color.Info" Style="flex: 1;" />
                                                <MudText Typo="Typo.caption">@progress.Value.ToString("P0")</MudText>
                                            </div>
                                        }
                                        else
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                        }
                                    </td>
                                    <td style="text-align: right;">
                                        @if (job.StartedAt.HasValue)
                                        {
                                            var elapsed = DateTimeOffset.UtcNow - job.StartedAt.Value;
                                            <MudText Typo="Typo.body2">@elapsed.ToString(@"mm\:ss")</MudText>
                                        }
                                    </td>
                                    <td>
                                        <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                                       Size="Size.Small"
                                                       Title="View Details"
                                                       OnClick="@(() => NavigateToJobDetail(job))" />
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudCardContent>
            </MudCard>
        }

        @* Failed Jobs Section *@
        @if (ExecutionState.FailedJobs > 0)
        {
            <MudCard Class="mb-4" Elevation="0" Outlined="true">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Color="Color.Error">Failed Jobs</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                                   Size="Size.Small" StartIcon="@Icons.Material.Filled.Refresh"
                                   OnClick="@(() => OnRetryFailed.InvokeAsync())">
                            Retry All Failed
                        </MudButton>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudSimpleTable Dense="true" Hover="true">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Timeframe</th>
                                <th>Date Range</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var job in GetFailedJobs().Take(20))
                            {
                                <tr>
                                    <td>@job.Symbol</td>
                                    <td>@job.Timeframe</td>
                                    <td>@job.StartDate.ToString("yyyy-MM-dd") - @job.EndDate.ToString("yyyy-MM-dd")</td>
                                    <td class="error-text">@(job.Error ?? "Unknown error")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                    @if (ExecutionState.FailedJobs > 20)
                    {
                        <MudText Typo="Typo.caption" Class="mt-2 mud-text-secondary">
                            Showing 20 of @ExecutionState.FailedJobs failed jobs
                        </MudText>
                    }
                </MudCardContent>
            </MudCard>
        }

        @* Pending Jobs Table (with Promise Scores when prioritization enabled) *@
        @if (GetPendingJobs().Any())
        {
            <MudCard Class="mb-4" Elevation="0" Outlined="true">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            Pending Jobs
                            @if (ExecutionState.UsePrioritization)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="ml-2">Prioritized</MudChip>
                            }
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudSimpleTable Dense="true" Hover="true" FixedHeader="true" Style="max-height: 300px; overflow-y: auto;">
                        <thead>
                            <tr>
                                @if (ExecutionState.UsePrioritization && RankedJobs != null)
                                {
                                    <th style="text-align: center;">Promise</th>
                                }
                                <th style="text-align: center;">Priority</th>
                                <th>Symbol</th>
                                <th>Timeframe</th>
                                <th>Date Range</th>
                                <th style="text-align: right;">Max Backtests</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ExecutionState.UsePrioritization && RankedJobs != null)
                            {
                                @foreach (var ranked in RankedJobs.Take(50))
                                {
                                    <tr>
                                        <td style="text-align: center;">
                                            <MudTooltip Text="@ranked.Promise.Reasoning">
                                                <MudChip T="string" Size="Size.Small"
                                                         Color="@GetPromiseColor(ranked.Promise.Score)">
                                                    @ranked.Promise.Score.ToString("P0")
                                                </MudChip>
                                            </MudTooltip>
                                        </td>
                                        <td style="text-align: center;">@GetJobPriority(ranked.Job)</td>
                                        <td>@ranked.Job.Symbol</td>
                                        <td>@ranked.Job.Timeframe</td>
                                        <td>@ranked.Job.StartDate.ToString("yyyy-MM-dd") - @ranked.Job.EndDate.ToString("yyyy-MM-dd")</td>
                                        <td style="text-align: right;">@ranked.Job.Resolution.MaxBacktests.ToString("N0")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                @foreach (var job in GetPendingJobs().OrderBy(j => GetJobPriority(j)).Take(50))
                                {
                                    <tr>
                                        <td style="text-align: center;">@GetJobPriority(job)</td>
                                        <td>@job.Symbol</td>
                                        <td>@job.Timeframe</td>
                                        <td>@job.StartDate.ToString("yyyy-MM-dd") - @job.EndDate.ToString("yyyy-MM-dd")</td>
                                        <td style="text-align: right;">@job.Resolution.MaxBacktests.ToString("N0")</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </MudSimpleTable>
                    @{ var pendingCount = GetPendingJobs().Count(); }
                    @if (pendingCount > 50)
                    {
                        <MudText Typo="Typo.caption" Class="pa-2 mud-text-secondary">
                            Showing 50 of @pendingCount pending jobs
                        </MudText>
                    }
                </MudCardContent>
            </MudCard>
        }

        @* Completed Jobs Table *@
        <MudCard Elevation="0" Outlined="true">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Completed Jobs</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent Class="pa-0">
                <MudSimpleTable Dense="true" Hover="true" FixedHeader="true" Style="max-height: 400px; overflow-y: auto;">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Timeframe</th>
                            <th>Date Range</th>
                            <th style="text-align: right;">Score</th>
                            <th style="text-align: right;">Best AD</th>
                            <th style="text-align: right;">Backtests</th>
                            <th style="text-align: right;">Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var job in GetCompletedJobs().Take(100))
                        {
                            <tr @ondblclick="@(() => NavigateToJobDetail(job))" style="cursor: pointer;">
                                <td>@job.Symbol</td>
                                <td>@job.Timeframe</td>
                                <td>@job.StartDate.ToString("yyyy-MM-dd") - @job.EndDate.ToString("yyyy-MM-dd")</td>
                                <td style="text-align: right;">
                                    @if (job.Score.HasValue)
                                    {
                                        <MudText Color="@GetScoreColor(job.Score.Value)">@job.Score.Value.ToString("F2")</MudText>
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                                <td style="text-align: right;">@(job.BestAD?.ToString("F2") ?? "-")</td>
                                <td style="text-align: right;">@(job.TotalBacktests?.ToString("N0") ?? "-")</td>
                                <td style="text-align: right;">@(job.Duration?.ToString(@"mm\:ss") ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
                @if (ExecutionState.CompletedJobs > 100)
                {
                    <MudText Typo="Typo.caption" Class="pa-2 mud-text-secondary">
                        Showing 100 of @ExecutionState.CompletedJobs completed jobs
                    </MudText>
                }
            </MudCardContent>
        </MudCard>
    }
</div>

<style>
    .job-summary {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
    }

    .summary-card {
        padding: 16px;
        text-align: center;
        min-width: 120px;
        flex: 1;
    }

    .error-text {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--mud-palette-error);
    }
</style>

@code {
    [Parameter] public PlanExecutionState? ExecutionState { get; set; }
    [Parameter] public EventCallback OnRetryFailed { get; set; }
    [Parameter] public IReadOnlyList<RankedJob>? RankedJobs { get; set; }

    private PlanMatrixState? _matrixState;

    protected override async Task OnParametersSetAsync()
    {
        if (ExecutionState?.PlanId is { Length: > 0 } planId)
        {
            try
            {
                _matrixState = await MatrixService.GetStateAsync(planId);
            }
            catch
            {
                _matrixState = null;
            }
        }
    }

    private int GetJobPriority(OptimizationJob job) =>
        _matrixState?.GetEffectivePriority(job.Symbol, job.Timeframe) ?? 5;

    private IEnumerable<OptimizationJob> GetRunningJobs() =>
        ExecutionState?.Jobs.Where(j => j.Status == JobStatus.Running).OrderBy(j => j.StartedAt)
            ?? Enumerable.Empty<OptimizationJob>();

    private IEnumerable<OptimizationJob> GetCompletedJobs() =>
        ExecutionState?.Jobs.Where(j => j.Status == JobStatus.Completed).OrderByDescending(j => j.CompletedAt)
            ?? Enumerable.Empty<OptimizationJob>();

    private IEnumerable<OptimizationJob> GetPendingJobs() =>
        ExecutionState?.Jobs.Where(j => j.Status == JobStatus.Pending)
            ?? Enumerable.Empty<OptimizationJob>();

    private IEnumerable<OptimizationJob> GetFailedJobs() =>
        ExecutionState?.Jobs.Where(j => j.Status == JobStatus.Failed)
            ?? Enumerable.Empty<OptimizationJob>();

    private double? GetJobProgress(OptimizationJob job)
    {
        var task = JobRunner.GetActiveTask(job.Id) as LionFire.Trading.Automation.Optimization.OptimizationTask;
        if (task?.Progress == null) return null;
        return task.Progress.PerUn;
    }

    private void NavigateToJobDetail(OptimizationJob job)
    {
        if (ExecutionState == null) return;
        Navigation.NavigateTo($"/optimization/plan/{Uri.EscapeDataString(ExecutionState.PlanId)}/job/{Uri.EscapeDataString(job.Id)}");
    }

    private Color GetScoreColor(double score)
    {
        if (score >= 80) return Color.Success;
        if (score >= 60) return Color.Warning;
        return Color.Error;
    }

    private Color GetPromiseColor(double score) => score switch
    {
        >= 0.7 => Color.Success,
        >= 0.4 => Color.Warning,
        _ => Color.Default
    };
}
